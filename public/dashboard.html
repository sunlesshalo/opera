<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Panou de Vânzări</title>
  <!-- Include fișierul CSS extern sau stiluri inline -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    /* Containerul de autentificare și dashboard */
    #auth-container, #dashboard {
      padding: 20px;
    }
    /* Logout fixat în colțul stânga sus pe desktop */
    #logout-btn.desktop {
      position: fixed;
      top: 10px;
      left: 10px;
    }
    /* Containerul pentru butoane pe desktop */
    .button-container {
      margin-bottom: 20px;
    }
    /* Stilurile pentru tabele */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    /* Hamburger menu - ascuns pe desktop */
    .hamburger-menu {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
    .hamburger-menu button {
      background: none;
      border: none;
      font-size: 24px;
    }
    .menu-items {
      display: none;
      position: fixed;
      top: 50px;
      right: 10px;
      background: #fff;
      border: 1px solid #ccc;
      z-index: 1000;
      padding: 10px;
    }
    .menu-items button {
      display: block;
      width: 100%;
      margin: 5px 0;
    }
    /* Mobile styles */
    @media (max-width: 768px) {
      .button-container {
        display: none;
      }
      #logout-btn.desktop {
        display: none;
      }
      .hamburger-menu {
        display: block;
      }
    }
  </style>
  <!-- Load Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Container de autentificare -->
  <div id="auth-container">
    <h2>Autentificare</h2>
    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Parolă" required>
      <button type="submit">Autentificare</button>
      <p>Nu ai un cont? <a href="register.html">Înregistrează-te aici</a>.</p>
    </form>
  </div>

  <!-- Butoane fixe pentru desktop -->
  <button id="logout-btn" class="desktop">Deconectare</button>

  <!-- Hamburger menu pentru mobil -->
  <div class="hamburger-menu">
    <button id="hamburger-btn">&#9776;</button>
    <div class="menu-items" id="menu-items">
      <button id="logout-btn-mobile">Deconectare</button>
      <button id="export-csv-mobile">Exportă CSV</button>
      <button id="clear-orders-mobile">Șterge toate comenzile</button>
      <button id="refresh-mobile">Actualizare</button>
    </div>
  </div>

  <!-- Conținutul panoului (afișat după autentificare) -->
  <div id="dashboard" style="display: none;">
    <h1>Panou de Vânzări</h1>
    <!-- Container pentru butoanele desktop -->
    <div class="button-container">
      <button id="export-csv">Exportă CSV</button>
      <button id="clear-orders">Șterge toate comenzile</button>
      <button id="refresh">Actualizare</button>
    </div>

    <!-- Tabelul cu comenzi în așteptare -->
    <h2>Comenzi în așteptare</h2>
    <table id="pending-table">
      <thead>
        <tr>
          <th>Data comenzii</th>
          <th>Produse comandate</th>
          <th>Valoare comandă</th>
          <th>Nume cumpărător</th>
          <th>Loc</th>
          <th>Marchează ca pregătit</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Tabelul cu comenzi pregătite -->
    <h2>Comenzi pregătite</h2>
    <table id="prepared-table">
      <thead>
        <tr>
          <th>Data comenzii</th>
          <th>Produse comandate</th>
          <th>Valoare comandă</th>
          <th>Nume cumpărător</th>
          <th>Loc</th>
          <th>Anulează pregătirea</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Configurarea Supabase
    const supabaseUrl = 'https://xxazvjnafqjchvqwqklg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4YXp2am5hZnFqY2h2cXdxa2xnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5OTA1MjAsImV4cCI6MjA1NjU2NjUyMH0.PF9P_EvwV3XdjnjJC0w1WazqjZnDejiJnhImfe6sDFc';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // Elementele UI
    const authContainer = document.getElementById('auth-container');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const logoutBtnDesktop = document.getElementById('logout-btn');
    const logoutBtnMobile = document.getElementById('logout-btn-mobile');
    const pendingTableBody = document.querySelector('#pending-table tbody');
    const preparedTableBody = document.querySelector('#prepared-table tbody');
    const exportCsvBtn = document.getElementById('export-csv');
    const clearOrdersBtn = document.getElementById('clear-orders');
    const refreshBtn = document.getElementById('refresh');
    const exportCsvMobile = document.getElementById('export-csv-mobile');
    const clearOrdersMobile = document.getElementById('clear-orders-mobile');
    const refreshMobile = document.getElementById('refresh-mobile');
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const menuItems = document.getElementById('menu-items');

    // Ascultare pentru schimbări de stare de autentificare
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (session) {
        authContainer.style.display = 'none';
        dashboard.style.display = 'block';
        loadOrders();
        subscribeToOrders();
      } else {
        authContainer.style.display = 'block';
        dashboard.style.display = 'none';
      }
    });

    // Formular de autentificare cu mesaje de logare
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      console.log("Răspuns autentificare:", { data, error });
      if (error) {
        alert('Eroare la autentificare: ' + error.message);
      } else {
        alert("Autentificare reușită!");
      }
    });

    // Funcție comună de deconectare
    async function logout() {
      await supabaseClient.auth.signOut();
    }
    logoutBtnDesktop.addEventListener('click', logout);
    logoutBtnMobile.addEventListener('click', logout);

    // Funcție pentru a încărca comenzile din Supabase
    async function loadOrders() {
      let { data: orders, error } = await supabaseClient
        .from('orders')
        .select('*');
      if (error) {
        console.error("Eroare la încărcarea comenzilor:", error);
        return;
      }
      renderOrders(orders);
    }

    // Funcție pentru formatarea produselor comandate
    function formatOrderedItems(orderedItemsText) {
      let html = "";
      try {
        const items = JSON.parse(orderedItemsText);
        items.forEach(item => {
          const price = item.unit_amount / 100;
          html += `${item.name}, preț: ${price}, buc: ${item.quantity}<br>`;
        });
      } catch (e) {
        // Dacă parsing-ul eșuează, returnează textul original
        html = orderedItemsText;
      }
      return html;
    }

    // Renderizarea comenzilor în tabele în funcție de status
    function renderOrders(orders) {
      pendingTableBody.innerHTML = '';
      preparedTableBody.innerHTML = '';
      orders.forEach(order => {
        const tr = document.createElement('tr');
        const orderDate = new Date(order.order_date).toLocaleString();
        const orderedItemsHtml = formatOrderedItems(order.ordered_items);
        // Conversia valorii comenzii (divizare la 100)
        const orderValue = order.order_value / 100;
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${orderedItemsHtml}</td>
          <td>${orderValue}</td>
          <td>${order.buyer_name}</td>
          <td>${order.loc}</td>
        `;
        if (order.status === 'pending') {
          const td = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.addEventListener('change', () => {
            updateOrderStatus(order.id, 'prepared');
          });
          td.appendChild(checkbox);
          tr.appendChild(td);
          pendingTableBody.appendChild(tr);
        } else if (order.status === 'prepared') {
          const td = document.createElement('td');
          const undoBtn = document.createElement('button');
          undoBtn.textContent = 'Anulează pregătirea';
          undoBtn.addEventListener('click', () => {
            updateOrderStatus(order.id, 'pending');
          });
          td.appendChild(undoBtn);
          tr.appendChild(td);
          preparedTableBody.appendChild(tr);
        }
      });
    }

    // Actualizează statusul unei comenzi în Supabase
    async function updateOrderStatus(orderId, newStatus) {
      const { error } = await supabaseClient
        .from('orders')
        .update({ status: newStatus })
        .match({ id: orderId });
      if (error) {
        alert('Eroare la actualizarea comenzii: ' + error.message);
      }
    }

    // Abonare în timp real la modificări din tabelul "orders"
    function subscribeToOrders() {
      supabaseClient
        .from('orders')
        .on('*', payload => {
          loadOrders();
        })
        .subscribe();
    }

    // Exportă comenzile ca CSV
    async function exportCsv() {
      let { data: orders, error } = await supabaseClient
        .from('orders')
        .select('*');
      if (error) {
        alert('Eroare la preluarea comenzilor: ' + error.message);
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Data comenzii,Produse comandate,Valoare comandă,Nume cumpărător,Loc,Status\n";
      orders.forEach(order => {
        const orderDate = new Date(order.order_date).toLocaleString();
        const orderedItems = order.ordered_items;
        const orderValue = order.order_value / 100;
        const row = [
          orderDate,
          orderedItems,
          orderValue,
          order.buyer_name,
          order.loc,
          order.status
        ];
        csvContent += row.join(",") + "\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "comenzi.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    exportCsvBtn.addEventListener('click', exportCsv);
    exportCsvMobile.addEventListener('click', exportCsv);

    // Șterge toate comenzile, cu confirmare
    async function clearOrders() {
      if (confirm("Ești sigur că vrei să ștergi TOATE comenzile? Această acțiune nu poate fi anulată.")) {
        const { error } = await supabaseClient
          .from('orders')
          .delete()
          .neq('id', 0); // Șterge toate rândurile
        if (error) {
          alert('Eroare la ștergerea comenzilor: ' + error.message);
        }
      }
    }
    clearOrdersBtn.addEventListener('click', clearOrders);
    clearOrdersMobile.addEventListener('click', clearOrders);

    // Buton de actualizare (refresh)
    async function refreshOrders() {
      loadOrders();
    }
    refreshBtn.addEventListener('click', refreshOrders);
    refreshMobile.addEventListener('click', refreshOrders);

    // Funcționalitate pentru hamburger menu pe mobil
    hamburgerBtn.addEventListener('click', () => {
      if (menuItems.style.display === 'block') {
        menuItems.style.display = 'none';
      } else {
        menuItems.style.display = 'block';
      }
    });
  </script>
</body>
</html>
