<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Panou de Vânzări</title>
  <style>
    /* Responsive login form */
    #auth-container {
      width: 90%;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    #auth-container input,
    #auth-container button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      box-sizing: border-box;
      font-size: 18px;
    }
    /* Responsive order cards */
    .order-card {
      width: 90%;
      max-width: 500px;
      margin: 10px auto;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      box-sizing: border-box;
    }
    /* General styling */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    #dashboard {
      display: none;
    }
    #dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    #dashboard-header button {
      padding: 8px 12px;
      cursor: pointer;
    }
    /* Global toggle buttons in card view */
    #global-toggle {
      margin-bottom: 20px;
    }
    #global-toggle button {
      margin-right: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    /* Table view styling (unchanged for now) */
    #table-view {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: #fff;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
      font-size: 14px;
    }
    .table-buttons {
      margin-bottom: 10px;
    }
    .table-buttons button {
      margin-right: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
  </style>
  <!-- Include Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Login Form -->
  <div id="auth-container">
    <h2>Autentificare</h2>
    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Parolă" required>
      <button type="submit">Autentificare</button>
      <p>Nu ai un cont? <a href="register.html">Înregistrează-te aici</a>.</p>
    </form>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <!-- Dashboard header with logout button -->
    <div id="dashboard-header">
      <h1>Panou de Vânzări</h1>
      <button id="logout-btn">Deconectare</button>
    </div>
    <!-- Global toggle buttons (visible in card view) -->
    <div id="global-toggle">
      <button id="view-table-btn">Vizualizare în Tabel</button>
      <button id="refresh-cards">Actualizare</button>
    </div>
    <!-- Card view (default view, shows pending orders as cards) -->
    <div id="cards-view">
      <!-- Order cards will be generated here -->
    </div>

    <!-- Table view (full records, includes refresh, export and clear buttons) -->
    <div id="table-view">
      <div class="table-buttons">
        <button id="export-csv">Exportă CSV</button>
        <button id="clear-orders">Șterge toate comenzile</button>
        <button id="refresh-table">Actualizare</button>
      </div>
      <button id="back-to-cards">Înapoi la Carduri</button>
      <!-- Pending orders table -->
      <h2>Comenzi în așteptare</h2>
      <table id="pending-table">
        <thead>
          <tr>
            <th>Data comenzii</th>
            <th>Produse comandate</th>
            <th>Valoare comandă</th>
            <th>Nume cumpărător</th>
            <th>Adresă</th>
            <th>Loc</th>
            <th>Marchează ca pregătit</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <!-- Prepared orders table -->
      <h2>Comenzi pregătite</h2>
      <table id="prepared-table">
        <thead>
          <tr>
            <th>Data comenzii</th>
            <th>Produse comandate</th>
            <th>Valoare comandă</th>
            <th>Nume cumpărător</th>
            <th>Adresă</th>
            <th>Loc</th>
            <th>Anulează pregătirea</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // Initialize Supabase client
    const supabaseUrl = 'https://xxazvjnafqjchvqwqklg.supabase.co';
    const supabaseKey = 'YOUR_SUPABASE_KEY_HERE';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // DOM elements
    const authContainer = document.getElementById('auth-container');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const globalToggle = document.getElementById('global-toggle');
    const viewTableBtn = document.getElementById('view-table-btn');
    const refreshCardsBtn = document.getElementById('refresh-cards');
    const backToCardsBtn = document.getElementById('back-to-cards');
    const cardsView = document.getElementById('cards-view');
    const tableView = document.getElementById('table-view');
    const exportCsvBtn = document.getElementById('export-csv');
    const clearOrdersBtn = document.getElementById('clear-orders');
    const refreshTableBtn = document.getElementById('refresh-table');

    // Store current orders
    let currentOrders = [];

    // Check for an existing session on page load (prevents logout on refresh)
    (async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        authContainer.style.display = 'none';
        dashboard.style.display = 'block';
        loadOrders();
        subscribeToOrders();
      } else {
        authContainer.style.display = 'block';
        dashboard.style.display = 'none';
      }
    })();

    // Authentication state change listener
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (session) {
        authContainer.style.display = 'none';
        dashboard.style.display = 'block';
        loadOrders();
        subscribeToOrders();
      } else {
        authContainer.style.display = 'block';
        dashboard.style.display = 'none';
      }
    });

    // Login form submission
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        alert("Eroare la autentificare: " + error.message);
      } else {
        alert("Autentificare reușită!");
      }
    });

    // Logout functionality
    logoutBtn.addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
    });

    // View toggle: switch to table view (hides card view buttons)
    viewTableBtn.addEventListener('click', () => {
      globalToggle.style.display = 'none';
      cardsView.style.display = 'none';
      tableView.style.display = 'block';
      renderTables(currentOrders);
    });

    // Back button: switch back to card view
    backToCardsBtn.addEventListener('click', () => {
      tableView.style.display = 'none';
      globalToggle.style.display = 'block';
      cardsView.style.display = 'block';
      loadOrders();
    });

    // Refresh buttons in both views
    refreshCardsBtn.addEventListener('click', loadOrders);
    refreshTableBtn.addEventListener('click', loadOrders);

    // Load orders from Supabase
    async function loadOrders() {
      let { data: orders, error } = await supabaseClient
        .from('orders')
        .select('*');
      if (error) {
        console.error("Eroare la încărcarea comenzilor:", error);
        return;
      }
      currentOrders = orders;
      renderCards(orders);
      if (tableView.style.display === 'block') {
        renderTables(orders);
      }
    }

    // Format ordered items into HTML (each item on a new line)
    function formatOrderedItems(orderedItemsText) {
      let html = "";
      try {
        const items = JSON.parse(orderedItemsText);
        items.forEach(item => {
          const price = item.unit_amount / 100;
          html += `${item.name}, preț: ${price}, buc: ${item.quantity}<br>`;
        });
      } catch (e) {
        html = orderedItemsText;
      }
      return html;
    }

    // Render pending orders as cards
    function renderCards(orders) {
      cardsView.innerHTML = "";
      orders.forEach(order => {
        if (order.status === 'pending') {
          const card = document.createElement('div');
          card.className = "order-card";

          // Display only client name from buyer_name
          const name = order.buyer_name.split(" (")[0];
          const header = document.createElement('header');
          const nameEl = document.createElement('span');
          nameEl.textContent = name;
          const checkbox = document.createElement('input');
          checkbox.type = "checkbox";
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              updateOrderStatus(order.id, 'prepared');
            }
          });
          header.appendChild(nameEl);
          header.appendChild(checkbox);
          card.appendChild(header);

          // Ordered items
          const orderItemsEl = document.createElement('div');
          orderItemsEl.innerHTML = formatOrderedItems(order.ordered_items);
          card.appendChild(orderItemsEl);

          // Total order value
          const totalEl = document.createElement('div');
          totalEl.textContent = "Valoare totală: " + (order.order_value / 100);
          card.appendChild(totalEl);

          // Custom field "loc"
          const locEl = document.createElement('div');
          locEl.textContent = "Loc: " + order.loc;
          card.appendChild(locEl);

          cardsView.appendChild(card);
        }
      });
    }

    // Render orders in table view
    function renderTables(orders) {
      const pendingTableBody = document.querySelector('#pending-table tbody');
      const preparedTableBody = document.querySelector('#prepared-table tbody');
      pendingTableBody.innerHTML = "";
      preparedTableBody.innerHTML = "";
      orders.forEach(order => {
        // Extract name and address from buyer_name
        let name = order.buyer_name.split(" (")[0];
        let formattedAddress = "";
        const idx = order.buyer_name.indexOf(" (");
        if (idx !== -1) {
          const addressStr = order.buyer_name.substring(idx + 2, order.buyer_name.length - 1);
          try {
            const addressObj = JSON.parse(addressStr);
            formattedAddress = addressObj.line1;
            if (addressObj.line2 && addressObj.line2.trim() && addressObj.line2 !== "null") {
              formattedAddress += ", " + addressObj.line2;
            }
            formattedAddress += ", " + addressObj.city + ", " + addressObj.state + ", " + addressObj.postal_code + ", " + addressObj.country;
          } catch(e) {
            formattedAddress = "";
          }
        }
        const orderDate = new Date(order.order_date).toLocaleString();
        const orderedItemsHtml = formatOrderedItems(order.ordered_items);
        const orderValue = order.order_value / 100;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${orderedItemsHtml}</td>
          <td>${orderValue}</td>
          <td>${name}</td>
          <td>${formattedAddress}</td>
          <td>${order.loc}</td>
        `;
        if (order.status === 'pending') {
          const td = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.addEventListener('change', () => {
            updateOrderStatus(order.id, 'prepared');
          });
          td.appendChild(checkbox);
          tr.appendChild(td);
          pendingTableBody.appendChild(tr);
        } else if (order.status === 'prepared') {
          const td = document.createElement('td');
          const undoBtn = document.createElement('button');
          undoBtn.textContent = 'Anulează pregătirea';
          undoBtn.addEventListener('click', () => {
            updateOrderStatus(order.id, 'pending');
          });
          td.appendChild(undoBtn);
          tr.appendChild(td);
          preparedTableBody.appendChild(tr);
        }
      });
    }

    // Update order status in Supabase
    async function updateOrderStatus(orderId, newStatus) {
      const { error } = await supabaseClient
        .from('orders')
        .update({ status: newStatus })
        .match({ id: orderId });
      if (error) {
        alert("Eroare la actualizarea comenzii: " + error.message);
      } else {
        loadOrders();
      }
    }

    // Subscribe to real-time updates
    function subscribeToOrders() {
      supabaseClient
        .from('orders')
        .on('*', payload => {
          loadOrders();
        })
        .subscribe();
    }

    // Export orders as CSV (table view)
    async function exportCsv() {
      let { data: orders, error } = await supabaseClient
        .from('orders')
        .select('*');
      if (error) {
        alert("Eroare la preluarea comenzilor: " + error.message);
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Data comenzii,Produse comandate,Valoare comandă,Nume cumpărător,Adresă,Loc,Status\n";
      orders.forEach(order => {
        let name = order.buyer_name.split(" (")[0];
        let formattedAddress = "";
        const idx = order.buyer_name.indexOf(" (");
        if (idx !== -1) {
          const addressStr = order.buyer_name.substring(idx + 2, order.buyer_name.length - 1);
          try {
            const addressObj = JSON.parse(addressStr);
            formattedAddress = addressObj.line1;
            if (addressObj.line2 && addressObj.line2.trim() && addressObj.line2 !== "null") {
              formattedAddress += ", " + addressObj.line2;
            }
            formattedAddress += ", " + addressObj.city + ", " + addressObj.state + ", " + addressObj.postal_code + ", " + addressObj.country;
          } catch(e) {
            formattedAddress = "";
          }
        }
        const orderDate = new Date(order.order_date).toLocaleString();
        const orderedItems = order.ordered_items;
        const orderValue = order.order_value / 100;
        const row = [
          orderDate,
          orderedItems,
          orderValue,
          name,
          formattedAddress,
          order.loc,
          order.status
        ];
        csvContent += row.join(",") + "\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "comenzi.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    exportCsvBtn.addEventListener('click', exportCsv);

    // Clear all orders (table view)
    async function clearOrders() {
      if (confirm("Ești sigur că vrei să ștergi TOATE comenzile? Această acțiune nu poate fi anulată.")) {
        const { error } = await supabaseClient
          .from('orders')
          .delete()
          .neq('id', 0);
        if (error) {
          alert("Eroare la ștergerea comenzilor: " + error.message);
        }
      }
    }
    clearOrdersBtn.addEventListener('click', clearOrders);
  </script>
</body>
</html>
