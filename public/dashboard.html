<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Panou de Vânzări</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    /* Auth container */
    #auth-container {
      max-width: 400px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #auth-container input {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      box-sizing: border-box;
    }
    #auth-container button {
      width: 100%;
      padding: 10px;
    }
    /* Dashboard container */
    #dashboard {
      display: none;
    }
    /* Global view toggle button */
    .global-toggle {
      margin-bottom: 20px;
    }
    /* Card view styling */
    #cards-view {
      display: block;
    }
    .order-card {
      background: #fff;
      margin: 10px 0;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .order-card header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .order-card header span {
      flex: 1;
      font-weight: bold;
    }
    /* Table view styling */
    #table-view {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: #fff;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
    }
    .table-buttons {
      margin-bottom: 10px;
    }
    /* Mobile optimizations */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      table, .order-card {
        font-size: 14px;
      }
      #auth-container {
        margin: 20px auto;
        padding: 15px;
      }
    }
  </style>
  <!-- Load Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Container de autentificare -->
  <div id="auth-container">
    <h2>Autentificare</h2>
    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Parolă" required>
      <button type="submit">Autentificare</button>
      <p>Nu ai un cont? <a href="register.html">Înregistrează-te aici</a>.</p>
    </form>
  </div>

  <!-- Panoul principal (afișat după autentificare) -->
  <div id="dashboard">
    <!-- Butonul global pentru a schimba view-ul -->
    <div id="global-toggle" class="global-toggle">
      <!-- În modul card view, se va afișa "Vizualizare în Tabel" -->
      <button id="view-table-btn">Vizualizare în Tabel</button>
    </div>

    <!-- Card view: afișează comenzile în așteptare ca carduri -->
    <div id="cards-view">
      <!-- Cardurile vor fi generate dinamic -->
    </div>

    <!-- Table view: afișează înregistrări complete -->
    <div id="table-view">
      <div class="table-buttons">
        <button id="export-csv">Exportă CSV</button>
        <button id="clear-orders">Șterge toate comenzile</button>
      </div>
      <button id="back-to-cards">Înapoi la Carduri</button>
      <h2>Comenzi în așteptare</h2>
      <table id="pending-table">
        <thead>
          <tr>
            <th>Data comenzii</th>
            <th>Produse comandate</th>
            <th>Valoare comandă</th>
            <th>Nume cumpărător</th>
            <th>Loc</th>
            <th>Marchează ca pregătit</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h2>Comenzi pregătite</h2>
      <table id="prepared-table">
        <thead>
          <tr>
            <th>Data comenzii</th>
            <th>Produse comandate</th>
            <th>Valoare comandă</th>
            <th>Nume cumpărător</th>
            <th>Loc</th>
            <th>Anulează pregătirea</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // Configurarea Supabase
    const supabaseUrl = 'https://xxazvjnafqjchvqwqklg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4YXp2am5hZnFqY2h2cXdxa2xnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5OTA1MjAsImV4cCI6MjA1NjU2NjUyMH0.PF9P_EvwV3XdjnjJC0w1WazqjZnDejiJnhImfe6sDFc';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // Elementele DOM
    const authContainer = document.getElementById('auth-container');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const cardsView = document.getElementById('cards-view');
    const tableView = document.getElementById('table-view');
    const viewTableBtn = document.getElementById('view-table-btn');
    const backToCardsBtn = document.getElementById('back-to-cards');

    // Elemente pentru butoanele din tabel
    const exportCsvBtn = document.getElementById('export-csv');
    const clearOrdersBtn = document.getElementById('clear-orders');

    // Stocăm comenzile curente pentru a le reutiliza când se schimbă view-ul
    let currentOrders = [];

    // Autentificare: ascultăm schimbările stării de autentificare
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (session) {
        authContainer.style.display = 'none';
        dashboard.style.display = 'block';
        loadOrders();
        subscribeToOrders();
      } else {
        authContainer.style.display = 'block';
        dashboard.style.display = 'none';
      }
    });

    // Formular de autentificare
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      console.log("Răspuns autentificare:", { data, error });
      if (error) {
        alert("Eroare la autentificare: " + error.message);
      } else {
        alert("Autentificare reușită!");
      }
    });

    // Butonul de view toggle: din card view trecem la tabel
    viewTableBtn.addEventListener('click', () => {
      cardsView.style.display = 'none';
      tableView.style.display = 'block';
      renderTables(currentOrders);
    });

    // Butonul din tabel pentru a reveni la card view
    backToCardsBtn.addEventListener('click', () => {
      tableView.style.display = 'none';
      cardsView.style.display = 'block';
      loadOrders();
    });

    // Încarcă comenzile din Supabase
    async function loadOrders() {
      let { data: orders, error } = await supabaseClient
        .from('orders')
        .select('*');
      if (error) {
        console.error("Eroare la încărcarea comenzilor:", error);
        return;
      }
      currentOrders = orders;
      renderCards(orders);
      if (tableView.style.display === 'block') {
        renderTables(orders);
      }
    }

    // Formatează textul produselor comandate: fiecare produs pe rând, cu nume, preț (unit_amount/100) și cantitate
    function formatOrderedItems(orderedItemsText) {
      let html = "";
      try {
        const items = JSON.parse(orderedItemsText);
        items.forEach(item => {
          const price = item.unit_amount / 100;
          html += `${item.name}, preț: ${price}, buc: ${item.quantity}<br>`;
        });
      } catch (e) {
        html = orderedItemsText;
      }
      return html;
    }

    // Renderizează cardurile pentru comenzile pending
    function renderCards(orders) {
      cardsView.innerHTML = "";
      orders.forEach(order => {
        if (order.status === 'pending') {
          const card = document.createElement('div');
          card.className = "order-card";

          // Header: numele cumpărătorului cu checkbox pentru a marca comanda ca pregătită
          const header = document.createElement('header');
          const nameEl = document.createElement('span');
          nameEl.textContent = order.buyer_name;
          const checkbox = document.createElement('input');
          checkbox.type = "checkbox";
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              updateOrderStatus(order.id, 'prepared');
            }
          });
          header.appendChild(nameEl);
          header.appendChild(checkbox);
          card.appendChild(header);

          // Comandă: lista produselor comandate
          const orderItemsEl = document.createElement('div');
          orderItemsEl.innerHTML = formatOrderedItems(order.ordered_items);
          card.appendChild(orderItemsEl);

          // Valoare totală a comenzii
          const totalEl = document.createElement('div');
          totalEl.textContent = "Valoare totală: " + (order.order_value / 100);
          card.appendChild(totalEl);

          // Loc
          const locEl = document.createElement('div');
          locEl.textContent = "Loc: " + order.loc;
          card.appendChild(locEl);

          cardsView.appendChild(card);
        }
      });
    }

    // Renderizează view-ul în formă de tabel: afișăm două tabele – unul pentru comenzile pending și unul pentru cele prepared
    function renderTables(orders) {
      const pendingTableBody = document.querySelector('#pending-table tbody');
      const preparedTableBody = document.querySelector('#prepared-table tbody');
      pendingTableBody.innerHTML = "";
      preparedTableBody.innerHTML = "";
      orders.forEach(order => {
        const tr = document.createElement('tr');
        const orderDate = new Date(order.order_date).toLocaleString();
        const orderedItemsHtml = formatOrderedItems(order.ordered_items);
        const orderValue = order.order_value / 100;
        tr.innerHTML = `
          <td>${orderDate}</td>
          <td>${orderedItemsHtml}</td>
          <td>${orderValue}</td>
          <td>${order.buyer_name}</td>
          <td>${order.loc}</td>
        `;
        if (order.status === 'pending') {
          const td = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.addEventListener('change', () => {
            updateOrderStatus(order.id, 'prepared');
          });
          td.appendChild(checkbox);
          tr.appendChild(td);
          pendingTableBody.appendChild(tr);
        } else if (order.status === 'prepared') {
          const td = document.createElement('td');
          const undoBtn = document.createElement('button');
          undoBtn.textContent = 'Anulează pregătirea';
          undoBtn.addEventListener('click', () => {
            updateOrderStatus(order.id, 'pending');
          });
          td.appendChild(undoBtn);
          tr.appendChild(td);
          preparedTableBody.appendChild(tr);
        }
      });
    }

    // Actualizează statusul unei comenzi
    async function updateOrderStatus(orderId, newStatus) {
      const { error } = await supabaseClient
        .from('orders')
        .update({ status: newStatus })
        .match({ id: orderId });
      if (error) {
        alert("Eroare la actualizarea comenzii: " + error.message);
      } else {
        loadOrders();
      }
    }

    // Abonare în timp real la modificări în tabelul "orders"
    function subscribeToOrders() {
      supabaseClient
        .from('orders')
        .on('*', payload => {
          loadOrders();
        })
        .subscribe();
    }

    // Exportă comenzile ca CSV (doar în view-ul de tabel)
    async function exportCsv() {
      let { data: orders, error } = await supabaseClient
        .from('orders')
        .select('*');
      if (error) {
        alert("Eroare la preluarea comenzilor: " + error.message);
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Data comenzii,Produse comandate,Valoare comandă,Nume cumpărător,Loc,Status\n";
      orders.forEach(order => {
        const orderDate = new Date(order.order_date).toLocaleString();
        const orderedItems = order.ordered_items;
        const orderValue = order.order_value / 100;
        const row = [
          orderDate,
          orderedItems,
          orderValue,
          order.buyer_name,
          order.loc,
          order.status
        ];
        csvContent += row.join(",") + "\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "comenzi.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    exportCsvBtn.addEventListener('click', exportCsv);

    // Șterge toate comenzile (doar în view-ul de tabel)
    async function clearOrders() {
      if (confirm("Ești sigur că vrei să ștergi TOATE comenzile? Această acțiune nu poate fi anulată.")) {
        const { error } = await supabaseClient
          .from('orders')
          .delete()
          .neq('id', 0);
        if (error) {
          alert("Eroare la ștergerea comenzilor: " + error.message);
        }
      }
    }
    clearOrdersBtn.addEventListener('click', clearOrders);
  </script>
</body>
</html>
